---
output:
  html_document: default
  pdf_document: default
---

```{r, eval=F,include=F}
rm(list = ls())
library(tidyverse)
library(MRIcloudT1volumetrics)


roiDir = paste0(getwd(),'/data')
file_list = dir(roiDir)
# readSubjectDf(file_list[1])$level

# run it in console
# setwd("C:/Users/lcqi/Desktop/data_analysis_bcaffo_lab/MRI_data_analysis/data")
data = readFileList(fileList = file_list,fixBF = TRUE)
save(data, file = 'raw.rda')


```


# type 1 level 1
```{r}
# note function spreadROIs() doesn't work very well
# data = readFileList(fileList = file_list,fixBF = TRUE) %>% spreadROIs()

rm(list = ls())
library(tidyverse)
library(MRIcloudT1volumetrics)

load(file = 'raw.rda')
if(T){
data = data %>% filter(type==1,level==1) %>% 
  select(rawid,roi,volume) %>% spread(roi,volume) 

# convert the rawid to be compatible with the format in lookup table
data$rawid = sapply(strsplit(data$rawid,"_"),function(x) x[1])

# compositional analysis
data = data %>% lapply(function(x) as.numeric(x)) %>% as.data.frame
data = cbind(data[1],prop.table(as.matrix(data[-1]), margin = 1))
data = data[-1]
}

```


# determinant of concentration matrix close to 0
# the matrix is not positive definite ~ singular


```{r}
library(glasso)
library(qgraph)


gs = lapply(seq(0,0.00005,0.00001), function(i){
  qgraph(glasso(cov(data),rho = i),
       labels = colnames(cov(data)),
       # filetype = 'pdf',
       # filename = paste0('rho=',i),
       # layout = matrix(1:12,nrow = 4),
       # DoNotPlot = TRUE,
       details = TRUE,
       directed = TRUE)
})
# layout(matrix(c(1:6),2,3,byrow =TRUE))
# # layout.show()
# plot(gs[[1]])
# plot(gs[[2]])
# lapply(gs, plot)
```





```{r}
library(corrplot)
corrplot(cor(data),
         # addCoef.col = T,
         method = 'color',
         type = 'upper',
         order = 'hclust',
         p.mat = cor.mtest(data, conf.level = .95)$p
         )
# interesting results of Telencephalon
library(randomForest)
lapply(colnames(data), function(i){
  # fml = paste0(i,"~.-",i) %>% as.formula()
  fml = paste0(i,"~.") %>% as.formula()
  data.rf = randomForest(fml, data, importance = TRUE)
  varImpPlot(data.rf,
             main = i)
})
```




























```{r}
library(glasso)
library(qgraph)
# s = glasso(cor(data),rho = 0.1)
# qgraph(s,
#        labels = colnames(cor(data)),
#        # filetype = 'pdf',
#        details = TRUE,
#        directed = TRUE)


lapply(seq(0,0.5,0.1), function(i){
  s = glasso(cor(data),rho = i)
  qgraph(s,
       labels = colnames(cor(data)),
       # filetype = 'pdf',
       # filename = paste0('rho=',i),
       details = TRUE,
       directed = TRUE)
})

```


# garbage code


```{r, eval = FALSE}
file.sources = list.files(c("C:/Users/lcqi/Desktop/data_analysis_bcaffo_lab/MRI_data_analysis/muvis"), 
                          pattern="*.R$", full.names=TRUE, 
                          ignore.case=TRUE)
sapply(file.sources,source,.GlobalEnv)
library(tidyverse)
library(psych)

data(bfi)
bfi <- bfi[,1:25]
data = bfi %>% na.omit()
nhanes_dgm <- dgm(data, dtype = "gaussian", alpha = 1e-15, plot = F)

# Find the largest connected component
library(igraph)
grph_clustrs <- clusters(nhanes_dgm$graph)
new_dgm <- induced.subgraph(nhanes_dgm$graph, V(nhanes_dgm$graph)[which(grph_clustrs$membership == which.max(grph_clustrs$csize))])

# Visualize the graph
dgm_vis <- graph_vis(new_dgm, plot = F, directed = T)
dgm_vis <- graph_vis(nhanes_dgm$graph, plot = F, directed = T)
dgm_vis$network

```




